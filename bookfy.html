<!DOCTYPE html>
<html>
<head>
  <title>Readability playground</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
</head>
<body>
  <div id="controls">
    <input id="uri" placeholder="A web article" value="http://coding.smashingmagazine.com/2011/01/12/guidelines-for-responsive-web-design/">
    <button id="uri-action">Go!</button>
  </div>
  <hr>
  <div id="content">
    <!-- content goes here -->
  </div>
  <style type="text/css">
    #uri {
      width: 30em;
    }

    #content {
      margin: 1em;
      font-size: 150%;
    }
  </style>
  <script type="text/javascript">
    /*
      Concerned with retrieving parsable DOM objects for an article
    */
    var readability = {
      contentHead: function(allContent) {
        /* returns the head element of the relevant content */

        //BUG this is horribly wrong, but will do for now
        return $(allContent).find("p").first().siblings().addBack().first();
      },
      token: "3f5c9f6c9869dbb23897ffe7c06f79ea4c1f1963",
      apiRoot: "http://readability.com",
      apiCallUrl: function(contentUrl) {
        return readability.apiRoot + "/api/content/v1/parser?url=" + contentUrl + "&token=" + readability.token;
      },
      getContent: function(contentUrl, successFn, errorFn) {
        //FIXME change to map of params
        /* Slurps content from the given url and passes the first element to success */
        var apiCallUrl = readability.apiCallUrl(contentUrl);

        console.log("Trying to load " + apiCallUrl);
        $.ajax({
          url: apiCallUrl,
          dataType: "jsonp",
          success: function(results){
            console.log("Loaded " + results.url);
            var allContent = $.parseHTML(results.content);

            successFn(readability.contentHead(allContent));
          },
          error: errorFn
        });
      }
    };

    /*
      Concerned with rendering DOM data to the page.

      NB: the elements that are rendered to the page are clones of the
      elements referenced in the pointer map. This separation can be confusing.
    */
    var sdufresne = {
      elementOffPage: function(element) {
        var elBottom = element.offset().top + element.height();
        var screenHeight = $(window).height();
        // console.log("El at " + elBottom + " of " + screenHeight);
        return (elBottom > screenHeight) ? true : false;
      },
      renderCurrent: function(pointer) {
        /* (re)renders the current page of content */
        $("#content").empty();

        var resultingPointer = {pageHead: pointer.pageHead};
        pointer.pageHead.nextAll().addBack().each(function() {
          var pageElement = $(this).clone();
          $("#content").append(pageElement);
          if (sdufresne.elementOffPage(pageElement)) {
            pageElement.remove();
            resultingPointer.nextPageHead = $(this);
            return false;
          }
        });
        return resultingPointer;
      },
      renderForward: function(pointer) {
        /* Renders the next page of content */
        $("#content").empty();

        var resultingPointer = {pageHead: pointer.nextPageHead};
        pointer.nextPageHead.nextAll().addBack().each(function() {
          var pageElement = $(this).clone();
          $("#content").append(pageElement);
          if (sdufresne.elementOffPage(pageElement)) {
            pageElement.remove();
            resultingPointer.nextPageHead = $(this);
            return false;
          }
        });
        return resultingPointer;
      },
      renderBackward: function(pointer) {
        /* Renders the previous page of content */
        $("#content").empty();

        var resultingPointer = {nextPageHead: pointer.pageHead};
        var pageTail = null;
        pointer.pageHead.prevAll().each(function() {
          var pageElement = $(this).clone();

          if (! pageTail) pageTail = pageElement;

          $("#content").prepend(pageElement);
          if (sdufresne.elementOffPage(pageTail)) {
            pageElement.remove();
            resultingPointer.pageHead = $(this).next();
            return false;
          }
        });
        return resultingPointer;
      }
    };

    $(function() {
      // TODO put this in a better place
      var pointer = {
        // The node at the top of the *current* page
        pageHead: null,
        // The node that will be at the top of the *next* page
        nextPageHead: null
      };

      $("#uri-action").click(function() {
        readability.getContent($("#uri").val(),
          function(contentHeadNode) {
            pointer = sdufresne.renderCurrent({pageHead: contentHeadNode});

            console.log("Initial render complete");
            console.log(pointer);
          },
          function(e) {
            console.log(e)
            alert("Something went wrong, check the console");
          });
      });
      $(document).keydown(function(e) {
        //TODO clean up, switch or something better
        if (e.keyCode == 39) {
          // Right
          pointer = sdufresne.renderForward(pointer);
          console.log("Next page complete");
          console.log(pointer);
        } else if (e.keyCode == 37) {
          // Left
          pointer = sdufresne.renderBackward(pointer);
          console.log("Previous page complete");
          console.log(pointer);
        }
      });
      $(window).resize(function() {
        //FIXME something (threading?) is causing this to be unstable if you
        // drag resize. Maximise etc works correctly
        pointer = sdufresne.renderCurrent(pointer);
        console.log("Current page re-rendered");
        console.log(pointer);
      });
    });
  </script>
</body>
</html>